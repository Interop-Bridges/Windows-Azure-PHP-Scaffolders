<?php

/**
 * @file
 * Perform bulk exports.
 */

/**
 * Implements hook_permission().
 */
function bulk_export_permission() {
  return array(
    'use bulk exporter' => array(
      'title' => t('Access Bulk Exporter'),
      'description' => t('Export various system objects into code.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function bulk_export_menu() {
  $items['admin/structure/bulk-export'] = array(
    'title' => 'Bulk Exporter',
    'description' => 'Bulk-export multiple CTools-handled data objects to code.',
    'access arguments' => array('use bulk exporter'),
    'page callback' => 'bulk_export_export',
  );
  $items['admin/structure/bulk-export/results'] = array(
    'access arguments' => array('use bulk exporter'),
    'page callback' => 'bulk_export_export',
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * FAPI gateway to the bulk exporter.
 */
function bulk_export_export() {
  ctools_include('export');
  $schemas = ctools_export_get_schemas(TRUE);
  $exportables = $export_tables = array();

  foreach ($schemas as $table => $schema) {
    if (!empty($schema['export']['list callback']) && function_exists($schema['export']['list callback'])) {
      $exportables[$table] = $schema['export']['list callback']();
    }
    else {
      $exportables[$table] = ctools_export_default_list($table, $schema);
    }
    natcasesort($exportables[$table]);
    $export_tables[$table] = $schema['module'];
  }
  if ($exportables) {
    $form_state = array(
      're_render' => FALSE,
      'no_redirect' => TRUE,
      'exportables' => $exportables,
      'export_tables' => $export_tables,
    );
    $output = drupal_build_form('bulk_export_export_form', $form_state);
    if (!empty($form_state['submitted'])) {
      drupal_set_title(t('Bulk export results'));
      $output = '';
      $module_code = '';
      $api_code = array();
      $dependencies = array();
      foreach ($form_state['code'] as $module => $api_info) {
        if ($module == 'general') {
          $module_code .= $api_info;
        }
        else {
          foreach ($api_info as $api => $info) {
            $api_hook = ctools_plugin_api_get_hook($module, $api);
            if (empty($api_code[$api_hook])) {
              $api_code[$api_hook] = '';
            }
            $api_code[$api_hook] .= "  if (\$module == '$module' && \$api == '$api') {\n";
            $api_code[$api_hook] .= "    return array('version' => $info[version]);\n";
            $api_code[$api_hook] .= "  }\n";
            $dependencies[$module] = TRUE;

            $file = $form_state['module'] . '.' . $api . '.inc';
            $code = "<?php\n\n";
            $code .= "/**\n";
            $code .= " * @file\n";
            $code .= " * Bulk export of $api objects generated by Bulk export module.\n";
            $code .= " */\n\n";
            $code .= $info['code'];
            $export_form = drupal_get_form('ctools_export_form', $code, t('Place this in @file', array('@file' => $file)));
            $output .= drupal_render($export_form);
          }
        }
      }

      // Add hook_ctools_plugin_api at the top of the module code, if there is any.
      if ($api_code) {
        foreach ($api_code as $api_hook => $text) {
          $api =  "\n/**\n";
          $api .= " * Implement hook_$api_hook().\n";
          $api .= " */\n";
          $api .= "function $form_state[module]_$api_hook(\$module, \$api) {\n";
          $api .= $text;
          $api .= "}\n";
          $module_code = $api . $module_code;
        }
      }

      if ($module_code) {
        $module =  "<?php\n\n";
        $module .= "/**\n";
        $module .= " * @file\n";
        $module .= " * Bulk export of objects generated by Bulk export module.\n";
        $module .= " */\n";
        $module .= $module_code;
        $export_form = drupal_get_form('ctools_export_form', $module, t('Place this in @file', array('@file' => $form_state['module'] . '.module')));
        $output = drupal_render($export_form) . $output;
      }

      $info = strtr("name = @module export module\n", array('@module' => $form_state['module']));
      $info .= strtr("description = Export objects from CTools\n", array('@module' => $form_state['values']['name']));
      foreach ($dependencies as $module => $junk) {
        $info .= "dependencies[] = $module\n";
      }
      $info .= "package = Chaos tool suite\n";
      $info .= "core = 7.x\n";
      $export_form = drupal_get_form('ctools_export_form', $info, t('Place this in @file', array('@file' => $form_state['module'] . '.info')));
      $output = drupal_render($export_form) . $output;

    }

    return $output;
  }
  else {
    return t('There are no objects to be exported at this time.');
  }
}

/**
 * FAPI definition for the bulk exporter form.
 *
 */
function bulk_export_export_form($form, &$form_state) {
  $form['tables'] = array(
    '#prefix' => '<div class="clearfix">',
    '#suffix' => '</div>',
    '#tree' => TRUE,
  );

  $files = system_rebuild_module_data();

  $options = array();
  foreach ($form_state['exportables'] as $table => $list) {
    if (empty($list)) {
      continue;
    }

    foreach ($list as $id => $title) {
      $options[$table][$id] = array($title);
    }

    $module = $form_state['export_tables'][$table];
    $header = array("{$files[$module]->info['name']}: $table");

    $form['tables'][$table] = array(
      '#prefix' => '<div class="export-container">',
      '#suffix' => '</div>',
      '#type' => 'tableselect',
      '#header' => $header,
      '#options' => $options[$table],
    );
  }

  $form['name'] = array(
    '#type' => 'textfield',
    '#title' => t('Module name'),
    '#description' => t('Enter the module name to export code to.'),
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Export'),
  );

  $form['#action'] = url('admin/structure/bulk-export/results');
  $form['#attached']['css'][] = drupal_get_path('module', 'bulk_export') . '/bulk_export.css';
  return $form;
}

/**
 * Process the bulk export submit form and make the results available.
 */
function bulk_export_export_form_submit($form, &$form_state) {
  $code = array();
  $name = empty($form_state['values']['name']) ? 'foo' : $form_state['values']['name'];

  foreach ($form_state['values']['tables'] as $table => $names) {
    $names = array_keys(array_filter($names));
    if ($names) {
      natcasesort($names);
      ctools_export_to_hook_code($code, $table, $names, $name);
    }
  }

  $form_state['code'] = $code;
  $form_state['module'] = $name;
}
